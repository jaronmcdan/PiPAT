# /etc/roi/roi.env (example)
#
# This file is OPTIONAL.
# - The code has sane defaults in config.py
# - Any value here overrides config.py via environment variables
# - The systemd unit loads this file automatically

# --- CAN ---
# CAN backend:
#   socketcan (default): Linux SocketCAN netdev (e.g. can0/can1)
#   rmcanview          : RM/Proemion CANview USB via serial (Byte Command Protocol)
#
# For socketcan:
#   CAN_CHANNEL=can0 (or can1, ...)
# For rmcanview:
#   CAN_CHANNEL=/dev/ttyUSB0 (or /dev/serial/by-id/...) 
#   CAN_SERIAL_BAUD=USB-serial port baud (NOT the CAN bus bitrate)
CAN_INTERFACE=socketcan
CAN_CHANNEL=can0
CAN_BITRATE=250000
# Serial baud for rmcanview (ignored by socketcan). Many USB-serial links work with
# any setting; keep 115200 unless you have reason to change it.
CAN_SERIAL_BAUD=115200

# If using rmcanview, reset the gateway CAN controller on startup to clear
# latched error status LEDs/counters.
CAN_CLEAR_ERRORS_ON_INIT=1

# Set to 0 if you bring up/configure the CAN backend elsewhere.
CAN_SETUP=1

# Outgoing readback publish rate (ms). Set <=0 to disable TX scheduling.
CAN_TX_ENABLE=1
CAN_TX_PERIOD_MS=50

# --- Serial multimeter ---
MULTI_METER_PATH=/dev/ttyUSB0
MULTI_METER_BAUD=38400

# --- Optional USB/VISA auto-detection ---
# Recommended on Raspberry Pi if /dev/ttyUSB* renumbers.
AUTO_DETECT_ENABLE=1
AUTO_DETECT_VERBOSE=1
AUTO_DETECT_PREFER_BY_ID=1
# Closed/fixed systems: avoid probing unknown ports.
# AUTO_DETECT_BYID_ONLY=1
# Force backend (empty => default). "@py" uses pyvisa-py.
# AUTO_DETECT_VISA_BACKEND=@py
# Runtime backend for AFG/E-load I/O (defaults to AUTO_DETECT_VISA_BACKEND).
# VISA_BACKEND=@py
# Optional IDN matching hints (comma-separated)
# AUTO_DETECT_MMETER_IDN_HINTS=multimeter,5491b
# AUTO_DETECT_AFG_IDN_HINTS=afg,function,generator,arb
# AUTO_DETECT_ELOAD_IDN_HINTS=load,eload,electronic load,dl,it,bk

# Optional by-id name hints (comma-separated). These are matched against
# filenames in /dev/serial/by-id. Useful to pin known devices without probing.
# AUTO_DETECT_MMETER_BYID_HINTS=5491b,multimeter
# AUTO_DETECT_MRSIGNAL_BYID_HINTS=mr.signal,lanyi
# AUTO_DETECT_K1_BYID_HINTS=arduino,arduino_micro,relay
# AUTO_DETECT_CANVIEW_BYID_HINTS=canview
# AUTO_DETECT_AFG_BYID_HINTS=afg

# Extra autodetect targets (enabled by default)
# AUTO_DETECT_K1_SERIAL=1
# AUTO_DETECT_CANVIEW=1

# --- VISA ---
# VISA backend ("@py" is recommended on Raspberry Pi).
# VISA_BACKEND=@py
ELOAD_VISA_ID=USB0::11975::34816::*::0::INSTR
AFG_VISA_ID=ASRL/dev/ttyACM0::INSTR

# If USB devices enumerate slowly at boot, increase these (defaults are fine for most):
# VISA_ENUM_RETRIES=3
# VISA_ENUM_RETRY_DELAY_SEC=0.5

# --- K1 relay drive ---

# K1 relay backend:
#   auto     = prefer the USB-serial relay backend when configured (default)
#   serial   = force USB-serial relay (Arduino)
#   mock     = no hardware
#   disabled = same as K1_ENABLE=0
# Note: legacy GPIO/relay-hat support has been removed.
K1_BACKEND=auto

# USB-serial relay backend (Arduino)
# Use a stable by-id path when possible.
# Example: K1_SERIAL_PORT=/dev/serial/by-id/usb-Arduino* 
#K1_SERIAL_PORT=
K1_SERIAL_BAUD=9600
K1_SERIAL_RELAY_INDEX=1
K1_SERIAL_BOOT_DELAY_SEC=2.0

# Optional explicit protocol characters (leave blank for defaults)
#K1_SERIAL_ON_CHAR=1
#K1_SERIAL_OFF_CHAR=a
# Invert CAN bit0 before driving K1 (optional)
K1_CAN_INVERT=0
# Idle K1 drive on timeout/startup
K1_IDLE_DRIVE=0

# --- Control watchdog (seconds) ---
CONTROL_TIMEOUT_SEC=2.0

# PAT switching matrix dashboard timeout (seconds).
#
# The PAT footer is driven by passively snooping PAT_J0..PAT_J5 frames. If those
# frames stop (PAT unplugged / bus quiet), the dashboard would otherwise keep
# showing the last captured (stale) routes forever.
#
# Set <=0 to disable stale blanking and always show the last seen values.
PAT_MATRIX_TIMEOUT_SEC=2.0

K1_TIMEOUT_SEC=2.0
ELOAD_TIMEOUT_SEC=2.0
AFG_TIMEOUT_SEC=2.0
MMETER_TIMEOUT_SEC=2.0

# If True, apply idle states immediately on startup before processing controls.
APPLY_IDLE_ON_STARTUP=1

# --- Idle behavior ---
# E-load idle means input OFF by default (safety)
ELOAD_IDLE_INPUT_ON=0
ELOAD_IDLE_SHORT_ON=0

# AFG idle means output OFF by default (safety)
AFG_IDLE_OUTPUT_ON=0

# --- Dashboard / polling ---
# Rich TUI render rate (frames/sec). Does not affect CAN.
DASH_FPS=15
# Instrument polling cadence (seconds)
MEAS_POLL_PERIOD=0.2
STATUS_POLL_PERIOD=1.0

# Optional multimeter serial timeouts (seconds)
MULTI_METER_TIMEOUT=1.0
MULTI_METER_WRITE_TIMEOUT=1.0

# CAN bus load estimator (dashboard)
CAN_BUS_LOAD_ENABLE=1
CAN_BUS_LOAD_WINDOW_SEC=1.0
CAN_BUS_LOAD_STUFFING_FACTOR=1.2
CAN_BUS_LOAD_OVERHEAD_BITS=48

# --- MrSignal / LANYI MR2.0 (Modbus RTU over USB serial) ---
MRSIGNAL_ENABLE=1
# Default /dev/ttyUSB1 to avoid colliding with the multimeter default.
MRSIGNAL_PORT=/dev/ttyUSB1
MRSIGNAL_BAUD=9600
MRSIGNAL_SLAVE_ID=1
MRSIGNAL_PARITY=N
MRSIGNAL_STOPBITS=1
MRSIGNAL_TIMEOUT=0.5

# Optional float byteorder overrides (only if reads/writes look wrong)
# MRSIGNAL_FLOAT_BYTEORDER=BYTEORDER_BIG_SWAP
MRSIGNAL_FLOAT_BYTEORDER_AUTO=1

# Safety clamps
MRSIGNAL_MAX_V=24.0
MRSIGNAL_MAX_MA=24.0

# Watchdog timeout (defaults to CONTROL_TIMEOUT_SEC)
MRSIGNAL_TIMEOUT_SEC=2.0
